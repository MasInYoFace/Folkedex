<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Song Details</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Fun title font -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 1500px;
            background-color: #fff8e1;
            background-image: linear-gradient(rgba(255, 255, 230, 0.5) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255, 255, 230, 0.5) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        h1#song-title {
            text-align: center;
            font-size: 48px;
            font-family: 'Fredoka One', cursive;
            margin-bottom: 20px;
            color: #333;
        }

        /* PDFs container */
        #pdfs {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
        }

        .pdf-block {
            position: relative;
            width: fit-content;
        }

        .pdf-image {
            max-width: 700px;
            width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            border: 1px solid #ddd;
            box-shadow: 0 0 6px rgba(0,0,0,0.2);
        }

        .download-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #0066cc;
            color: white;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .download-btn:hover {
            background: #004c99;
        }

        /* Metadata table */
        #song-info-table {
            width: 100%;
            max-width: 900px;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: #fffbe0;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        #song-info-table th,
        #song-info-table td {
            border: 1px solid #ccc;
            padding: 10px 15px;
            text-align: left;
            vertical-align: top;
        }

        #song-info-table th {
            background-color: #ffe680;
            font-size: 16px;
        }

        #song-info-table td {
            background-color: #fffdf5;
            font-size: 18px;
            white-space: pre-wrap; /* preserves line breaks from CSV */
        }

        /* MuseScore iframe */
        .musescore-container {
            margin-top: 30px;
        }
        .musescore-container iframe {
            width: 100%;
            height: 600px;
            border: 0;
        }
        .musescore-container span {
            font-size: 12px;
            display: block;
            margin-top: 4px;
        }
    </style>
</head>

<body>

<a href="index.html">‚Üê Back to Song List</a>
<h1 id="song-title"></h1>

<!-- PDFs -->
<div id="pdfs"></div>

<!-- Metadata -->
<div id="song-info"></div>

<!-- MuseScore embed -->
<div id="musescore" class="musescore-container"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const urlParams = new URLSearchParams(window.location.search);
const title = urlParams.get("title");
const decodedTitle = decodeURIComponent(title);

// Set page title
document.title = decodedTitle;

// Set heading
document.getElementById("song-title").innerText = decodedTitle;

async function renderPDFasImages(url, container) {
    const pdf = await pdfjsLib.getDocument(url).promise;
    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        canvas.className = "pdf-image";
        container.appendChild(canvas);
        await page.render({ canvasContext: context, viewport: viewport }).promise;
    }
}

Papa.parse("folksongs.csv", {
    download: true,
    header: true,
    complete: function(results) {
        const song = results.data.find(row => row.Title === title);
        if (!song) {
            document.getElementById("song-info").innerHTML = "<p>Song not found.</p>";
            return;
        }

        const pdfContainer = document.getElementById("pdfs");

        // PDFs
        if (song.PDFs) {
            const files = song.PDFs.split(",").map(f => f.trim());
            files.forEach((file, i) => {
                const pdfPath = `pdfs/${file}`;
                const block = document.createElement("div");
                block.className = "pdf-block";

                renderPDFasImages(pdfPath, block);

                const btn = document.createElement("button");
                btn.className = "download-btn";
                btn.innerText = `Download PDF ${i + 1}`;
                btn.onclick = () => window.open(pdfPath, "_blank");

                block.appendChild(btn);
                pdfContainer.appendChild(block);
            });
        }

        const infoDiv = document.getElementById("song-info");

        // Metadata order
        const metaOrder = [
            "Type", "Hardest Rhythmic", "Hardest Melodic", "Theme", "Grade Level", 
            "Classroom Use", "Origin", "Tone Set", "Scale", "Tonal Center", 
            "CSP", "Melodic Form", "Rhythmic Content", "Meter", "Rhythmic Form", "Source", 
            "Source Link", "Game", "Full Melody", "Full Rhythm"
        ];

        // Create table
        const table = document.createElement("table");
        table.id = "song-info-table";
        const tbody = document.createElement("tbody");

        metaOrder.forEach(key => {
            if (!song[key]) return;
            let value = song[key];
            if (key === "Source Link") value = `<a href="${value}" target="_blank">Source</a>`;
            if (key === "Full Melody" || key === "Full Rhythm") return;

            const tr = document.createElement("tr");
            const th = document.createElement("th");
            th.innerText = key;
            const td = document.createElement("td");
            td.innerHTML = value; // preserves line breaks
            tr.appendChild(th);
            tr.appendChild(td);
            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        infoDiv.appendChild(table);

        // MuseScore embed
        if (song["MuseScore Embed"]) {
            const musescoreDiv = document.getElementById("musescore");
            const embedUrl = song["MuseScore Embed"];
            const linkUrl = song["MuseScore Link"] || embedUrl;

            musescoreDiv.innerHTML = `
                <iframe src="${embedUrl}" allowfullscreen allow="autoplay; fullscreen"></iframe>
                <span>
                    <a href="${linkUrl}" target="_blank">${song.Title}</a> by <a href="https://musescore.com/user/14822371" target="_blank">Masinyoface</a>
                </span>
            `;
        }
    }
});
</script>

</body>
</html>
