<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Who's That FolkeSong?</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">

<style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #fffee0; }
    h1 { text-align: center; font-family: 'Fredoka One', cursive; }

    #game-container, #end-screen { max-width: 700px; margin: 0 auto; text-align: center; }

    #metadata-container { margin: 20px 0; font-size: 16px; }
    .metadata-item { margin: 4px 0; }

    #guess-input { padding: 10px; width: 65%; font-size: 16px; border-radius: 5px; border: 1px solid #999; }
    #submit-btn, #skip-btn { padding: 10px 20px; font-size: 16px; margin-left: 10px; border-radius: 5px; cursor: pointer; }

    #feedback { margin-top: 15px; font-weight: bold; }

    #start-screen { text-align: center; margin-top: 50px; }
    #start-btn { padding: 15px 30px; font-size: 18px; border-radius: 5px; cursor: pointer; margin-top: 20px; }

    #timer, #score { font-weight: bold; margin-top: 10px; font-size: 18px; }

    #score, .score-box {
        font-family: 'Press Start 2P', cursive;
        font-size: 28px;
        background-color: #fff8c0;
        border: 3px solid #999;
        border-radius: 10px;
        display: inline-block;
        padding: 10px 20px;
        box-shadow: 2px 2px 0 #999;
        margin-top: 10px;
    }

    .score-box {
        display: block;
        margin: 0 auto 20px;
        text-align: center;
    }

.difficulty-box {
    display: inline-block;
    text-align: center;
    padding: 20px;
    border: 3px solid #999;
    border-radius: 10px;
    background-color: #fff8c0;
    margin-top: 20px;
    font-family: 'Press Start 2P', cursive;
    font-size: 18px;
}

.difficulty-box strong {
    display: block;
    margin-bottom: 12px;
    font-size: 22px;
    text-align: center;
}

.difficulty-box label {
    display: block;
    margin: 12px 0;
    cursor: pointer;
    font-size: 16px;
}

.difficulty-box input[type="radio"] {
    transform: scale(1.3);
    margin-right: 8px;
}

#round-songs-container {
    display: inline-block;
    border: 3px solid #999;
    border-radius: 10px;
    padding: 10px;
    background-color: #fff8c0;
}

#round-songs-table {
    border-collapse: collapse;
    width: 100%;
}

#round-songs-table th,
#round-songs-table td {
    border: 2px solid #999;
    padding: 8px;
}

#round-songs-table tr.correct td {
    background-color: #c8f0c8;
    color: green;
}

#round-songs-table tr.skipped td {
    background-color: #f8c8c8;
    color: red;
}
</style>
</head>

<body>

<h1>Who's That FolkeSong?</h1>

<div id="start-screen">
    <div class="difficulty-box">
        <strong>Select Difficulty</strong>
        <label><input type="radio" name="difficulty" value="1" checked>Level 1</label>
        <label><input type="radio" name="difficulty" value="2">Level 2</label>
        <label><input type="radio" name="difficulty" value="3">Level 3</label>
    </div>
    <br>
    <button id="start-btn">Start Game</button>
</div>

<div id="game-container" style="display:none;">
    <div id="timer">Time: 120s</div>
    <div id="score">Score: 0</div>
    <div id="metadata-container">Loading songsâ€¦</div>
    <input type="text" id="guess-input" placeholder="Enter song titleâ€¦">
    <button id="submit-btn">Guess</button>
    <button id="skip-btn">Skip (-5s)</button>
    <div id="feedback"></div>
</div>

<div id="end-screen" style="display:none; margin-top:50px;">
    <div id="final-score" class="score-box">Score: 0</div>
    <div id="round-songs-container">
        <table id="round-songs-table">
            <thead>
                <tr>
                    <th>Song</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div>
        <button id="restart-btn" style="margin-top:20px; padding:10px 20px; font-size:16px;">Restart Game</button>
    </div>
</div>

<script>
const GAME_DURATION = 120;
const DIFFICULTY_LEVELS = {
    1: ["Theme", "Grade Level", "Origin", "Tone Set", "Full Melody"],
    2: ["Theme", "Grade Level", "Origin", "Tone Set", "Full Melody"],
    3: ["Theme", "Grade Level", "Origin", "Tone Set"]
};

window.ALL_SONGS = [];
let currentSong = null;
let timer = null;
let timeLeft = GAME_DURATION;
let score = 0;
let roundHistory = [];
let currentDifficulty = 1;

function getSongsForGame() {
    return window.ALL_SONGS.filter(s => s.Title);
}

function pickRandomSong() {
    const pool = getSongsForGame();
    if (!pool.length) return null;
    return pool[Math.floor(Math.random() * pool.length)];
}

// Level 1 hint: first letter + underscores with spaces
function getTitleHint(title) {
    if (!title) return "";
    return title.split(" ").map(word => {
        if (word.length === 1) return word;
        const letters = [word[0]];
        for (let i = 1; i < word.length; i++) letters.push("_");
        return letters.join(" ");
    }).join("  "); // double space between words
}

function renderMetadata(song) {
    const container = document.getElementById("metadata-container");
    container.innerHTML = "";
    if (!song) return;

    DIFFICULTY_LEVELS[currentDifficulty].forEach(field => {
        if (song[field]) {
            const div = document.createElement("div");
            div.className = "metadata-item";
            div.textContent = `${field}: ${song[field]}`;
            container.appendChild(div);
        }
    });

    if (currentDifficulty == 1 && song.Title) {
        const hintDiv = document.createElement("div");
        hintDiv.className = "metadata-item";
        hintDiv.textContent = "Hint: " + getTitleHint(song.Title);
        container.appendChild(hintDiv);
    }
}

function goToStartScreen() {
    clearInterval(timer);
    currentSong = null;
    document.getElementById("game-container").style.display = "none";
    document.getElementById("end-screen").style.display = "none";
    document.getElementById("start-screen").style.display = "block";
}

function levenshtein(a, b) {
    const m = a.length, n = b.length;
    const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            dp[i][j] = a[i-1] === b[j-1]
                ? dp[i-1][j-1]
                : 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
        }
    }
    return dp[m][n];
}

function isGuessCorrect(guess, title) {
    guess = guess.toLowerCase().trim();
    title = title.toLowerCase().trim();
    const maxDistance = Math.max(1, Math.floor(title.length * 0.15));
    return levenshtein(guess, title) <= maxDistance;
}

function newRound() {
    currentSong = pickRandomSong();
    renderMetadata(currentSong);
    document.getElementById("guess-input").value = "";
    document.getElementById("feedback").textContent = "";
}

function checkGuess() {
    const guess = document.getElementById("guess-input").value;
    if (!currentSong || !guess.trim()) return;

    if (isGuessCorrect(guess, currentSong.Title)) {
        const title = currentSong.Title;
        score++;
        roundHistory.push({ title, status: "correct" });
        document.getElementById("score").textContent = `Score: ${score}`;
        document.getElementById("feedback").textContent =
            `Correct! ðŸŽ‰ The song is: "${title}"`;
        setTimeout(newRound, 1500);
    } else {
        document.getElementById("feedback").textContent = "Try again!";
    }
}

function skipSong() {
    if (!currentSong) return;
    roundHistory.push({ title: currentSong.Title, status: "skipped" });
    timeLeft = Math.max(0, timeLeft - 5);
    document.getElementById("timer").textContent = `Time: ${timeLeft}s`;
    newRound();
    if (timeLeft === 0) endGame();
}

function startTimer() {
    timeLeft = GAME_DURATION;
    score = 0;
    roundHistory = [];
    document.getElementById("timer").textContent = `Time: ${timeLeft}s`;
    document.getElementById("score").textContent = `Score: ${score}`;
    timer = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").textContent = `Time: ${timeLeft}s`;
        if (timeLeft <= 0) endGame();
    }, 1000);
}

function endGame() {
    clearInterval(timer);

    if (currentSong) {
        // If time ran out, mark the current song as "Ran out of time"
        roundHistory.push({ title: currentSong.Title, status: "Ran out of time" });
        currentSong = null;
    }

    document.getElementById("game-container").style.display = "none";
    document.getElementById("final-score").textContent = `Score: ${score}`;

    const tbody = document.querySelector("#round-songs-table tbody");
    tbody.innerHTML = "";

    roundHistory.forEach(item => {
        const tr = document.createElement("tr");
        // lowercase class names for styling; optional: map status to CSS
        tr.className = item.status.toLowerCase().replace(/\s/g, '-'); 
        tr.innerHTML = `<td>${item.title}</td><td>${item.status}</td>`;
        tbody.appendChild(tr);
    });

    document.getElementById("end-screen").style.display = "block";
}

function startGame() {
    currentDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
    document.getElementById("start-screen").style.display = "none";
    document.getElementById("end-screen").style.display = "none";
    document.getElementById("game-container").style.display = "block";
    newRound();
    startTimer();
}

document.getElementById("submit-btn").addEventListener("click", checkGuess);
document.getElementById("guess-input").addEventListener("keydown", e => { if (e.key === "Enter") checkGuess(); });
document.getElementById("skip-btn").addEventListener("click", skipSong);
document.getElementById("start-btn").addEventListener("click", startGame);
document.getElementById("restart-btn").addEventListener("click", goToStartScreen);

Papa.parse("folksongs.csv", {
    download: true,
    header: true,
    complete: results => window.ALL_SONGS = results.data || []
});
</script>

</body>
</html>
